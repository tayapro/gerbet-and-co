{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="row">
    <h2 class="text-center mb-4 purple-text-75">Product list</h2>
    <button class="btn text-end"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#sideSortFilter"
            aria-controls="sideSortFilter">
        <img src="{% static 'icons/filters_purple.svg' %}" alt="filters icon " 
             class="m-4 opacity-75" id="filters-icon" title="Sort and Filter"
             data-bs-toggle="tooltip" data-bs-placement="bottom"
                             aria-label="Sort and Filter">
    </button>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="sideSortFilter"
        data-bs-backdrop="true" data-bs-scroll="false"
        aria-labelledby="sideSortFilterLabel">

        <div class="offcanvas-header">
            <h3 class="offcanvas-title" id="sideSortFilterLabel">Sort & Filter</h3>
            <button type="button" class="btn-close purple-text-90" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
    
        <div class="offcanvas-body d-flex flex-column gap-4">
            <form id="filter-form" class="filter-form" method="GET" 
                hx-get="{% url 'product_list' %}" hx-target="#product-list" hx-push-url="true">

                <!-- Sort section -->
                <p class="text-start fs-5 playfair-display-font-family">Sort By</p>
                <div class="mb-5 d-flex flex-column">
                    <div class="form-check ps-0 mb-1">
                        <input type="checkbox" name="order_by" value="price_asc" class="me-2">
                        <label class="form-check-label">
                            Price ascending
                        </label>
                    </div>
                    <div class="form-check ps-0 mb-1">
                        <input type="checkbox" name="order_by" value="price_desc" class="me-2">
                        <label class="form-check-label">
                            Price descending
                        </label>
                    </div>
                    <div class="form-check ps-0 mb-1">
                        <input type="checkbox" name="order_by" value="popularity" class="me-2">
                        <label class="form-check-label">
                            Recommendation
                        </label>
                    </div>
                </div>

                <!-- Filter section -->
                <p class="text-start fs-5 playfair-display-font-family">Filter By</p>
                <!-- Filter by Categories -->
                <div class="mb-3">
                    <p class="mb-1">Category:</p>
                    {% for category in categories %}
                        <div class="form-check ps-0 mb-1">
                            <input type="checkbox" name="category" value="{{ category.slug }}"
                                {% if category.slug in selected_categories %}checked{% endif %}
                                class="me-2">
                            <label class="form-check-label" for="cat-{{ category.id }}">
                                {{ category.name }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            
                <!-- Filter by Ratings -->
                <div class="mb-3">
                    <p class="mb-1">Rating:</p>
                    {% for rating in ratings %}
                        <div class="form-check ps-0 mb-1">
                            <input type="radio" name="min_rating" value="{{ rating }}"
                                {% if rating|stringformat:"s" == request.GET.min_rating %}checked{% endif %}
                                class="me-2">
                            <label class="form-check-label">
                                {{ rating }}+ stars
                            </label>
                        </div>
                    {% endfor %}
                </div>
            
                <!-- Filter by Price -->
                <div class="mb-3">
                    <p class="mb-1">Price:</p>
                    <label for="min_price" class="form-label">Min Price</label>
                    <input type="number" name="min_price" class="form-control" min="0" step="0.01" value="{{ min_price }}">
                    
                    <label for="max_price" class="form-label">Max Price</label>
                    <input type="number" name="max_price" class="form-control" min="0" step="0.01" value="{{ max_price }}">
                </div>
            </form>
        </div>
    </div>

    <div id="product-list">
        {% if selected_filters %}
        <!-- Show filter badges with clear/remove buttons -->
            <div class="mb-4">
                <p class="mb-2 text-light fw-semibold">Active Filters:</p>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    {% for label, url in selected_filters %}
                        <span class="badge rounded-pill bg-light text-dark px-3 py-2">
                            {{ label }}
                            <a href="{{ url }}" class="text-danger text-decoration-none ms-2" title="Remove">
                                &times;
                            </a>
                        </span>
                    {% endfor %}
                </div>
                <a href="{% url 'product_list' %}" class="btn btn-sm btn-outline-light ms-2">
                    Clear All Filters
                </a>
            </div>
        {% endif %}

        <div class="row row-cols-1 row-cols-md-3 row-cols-xl-4 g-4 mb-5 pb-5">
            {% include "products/product_cards.html" %}
        </div>
    </div>
</div>
{% endblock %}

{% block postloadjs %}
<script>
    console.log("Script loaded!");


    function updatePriceLabel(input) {
        const labelId = input.id + 'Label'
        document.getElementById(labelId).textContent = input.value
    }

    function updateSortLabel(event) {
        // Find the updated product list container
        const updatedList = document.getElementById("sort-control");
    
        // Search for the active button with aria-checked="true"
        const activeButton = updatedList.querySelector('[aria-checked="true"]');
    
        if (activeButton) {
            const label = activeButton.getAttribute("data-sort-label");
            const key = new URL(activeButton.getAttribute("hx-get"), window.location.origin).searchParams.get("order_by");
    
            const sortLabel = document.getElementById("sortLabel");
            const orderByInput = document.querySelector('input[name="order_by"]');
    
            // Update the sort label
            if (sortLabel && label) {
                sortLabel.textContent = label;
            }
    
            // Update the hidden input with the current sort key
            if (orderByInput && key) {
                orderByInput.value = key;
            }
    
            console.log("key", key);
            console.log("label", label);
        } else {
            console.log("No active button found.");
        }
    }    

    document.getElementById("product-list").addEventListener("htmx:afterSwap", function(evt) {
        console.log("HTMX afterSwap for product list triggered!");
        updateSortLabel(evt);
    });

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("filter-form")
        const inputs = form.querySelectorAll("input")
    
        inputs.forEach((input) => {
            input.addEventListener("change", () => {
                form.requestSubmit()
            })
        })
    })
</script>
{% endblock %}