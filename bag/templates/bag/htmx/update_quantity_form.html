{% block content %}
<form hx-post="{% url 'update_bag' item.product_id %}" 
      hx-trigger="submit, change from:input[name=quantity] delay:500ms" 
      hx-target="#bag-items-container" 
      hx-swap="outerHTML"
      class="d-inline-block update-form">

    <!-- Hidden default submit to prevent "decrease" from firing on Enter -->
    <button type="submit" name="action" value="update" hidden></button>

    {% csrf_token %}
    <div class="input-group">
        <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="99"
        class="form-control text-center qty_input m-0 p-0 px-1 order-2 rounded-0 {% if error %}is-invalid{% endif %}" 
        size="3" id="quantity-input-{{ item.product_id }}">

        <button type="submit" name="action" value="decrease"
                class="btn btn-outline-secondary btn-sm order-1 rounded-start"
                {% if item.quantity == 1 %}disabled{% endif %}>
            <i class="bi bi-dash"></i>
        </button>
        
        <button type="submit" name="action" value="increase"
                class="btn btn-outline-secondary btn-sm order-3">
            <i class="bi bi-plus"></i>
        </button>
    </div>
</form>
{% endblock %}

{% block postloadjs %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.querySelector("#quantity-input-{{ item.product_id }}");
        const form = input.closest("form");
    
        input.addEventListener("input", function () {
          const value = parseInt(input.value);
          const isValid = value >= 1 && value <= 99;
    
          if (isValid) {
            // Trigger the HTMX request programmatically
            form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }));
          } else {
            // Optionally show inline warning or reset
            input.classList.add("is-invalid");
          }
        });
      });
</script>
{% endblock %}
